{% extends "admin/base_site.html" %}

{% block content %}
<div style="text-align: center; margin: 20px auto; max-width: 800px; font-family: Arial, sans-serif;">
    <h1>Lançar Notas por Turma</h1>

    <p style="margin: 10px 0; font-size: 14px; color: #555;">
        Digite a média final para atualizar o status do estudante. 
        Caso o estudante seja DESISTENTE, insira <strong>-1</strong>.
    </p>

    <!-- Exibe mensagens de erro do formulário -->
    {% if errors %}
    <div style="margin-bottom: 20px; text-align: left; color: red;">
        <strong>Erros encontrados:</strong>
        <ul>
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="get" id="filter-form" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: center; gap: 10px; align-items: center;">
            <label for="turma" style="font-weight: bold;">Turma:</label>
            <select id="turma" name="turma" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">Selecione a turma</option>
                {% for turma in turmas %}
                <option value="{{ turma.id }}" {% if turma.id|stringformat:"s" == turma_id %}selected{% endif %}>
                    {{ turma.nome }}
                </option>
                {% endfor %}
            </select>

            <label for="disciplina" style="font-weight: bold;">Disciplina:</label>
            <select id="disciplina" name="disciplina" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">Selecione a disciplina</option>
                {% for disciplina in disciplinas %}
                <option value="{{ disciplina.id }}" {% if disciplina.id|stringformat:"s" == disciplina_id %}selected{% endif %}>
                    {{ disciplina.nome }}
                </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <form method="post">
        {% csrf_token %}
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background-color: #f2f2f2; text-align: left;">
                    <th style="padding: 10px; border: 1px solid #ccc;">#</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Estudante</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Nota Salva</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Editar Nota</th>
                    <th style="padding: 10px; border: 1px solid #ccc;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for estudante in estudantes_com_dados %}
                <tr>
                    <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">{{ forloop.counter }}</td>
                    <td style="padding: 10px; border: 1px solid #ccc;">{{ estudante.nome }}</td>
                    <td style="padding: 15px; border: 1px solid #ccc; text-align: center;">{{ estudante.nota|default:"Sem nota" }}</td>
                    <td style="padding: 10px; border: 1px solid #ccc; text-align: center;">
                        <input
                            type="number"
                            name="nota_{{ estudante.id }}"
                            value=""
                            placeholder="Nova nota"
                            min="-1"
                            max="10"
                            step="0.01"
                            style="width: 100px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; text-align: center;"
                        >
                    </td>
                    <td style="padding: 10px; border: 1px solid #ccc;">{{ estudante.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" name="salvar" style="
            margin-top: 20px; 
            padding: 10px 20px; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
        ">
            Salvar Notas
        </button>
    </form>
</div>

<script>
    // Adiciona comportamento para filtros dinâmicos
    document.addEventListener('DOMContentLoaded', function () {
        const turmaSelect = document.getElementById('turma');
        const disciplinaSelect = document.getElementById('disciplina');
        const form = document.getElementById('filter-form');

        turmaSelect.addEventListener('change', function () {
            form.submit();
        });

        disciplinaSelect.addEventListener('change', function () {
            form.submit();
        });
    });

    // Validação de entrada no frontend
    document.addEventListener('DOMContentLoaded', function () {
        const notaInputs = document.querySelectorAll('input[name^="nota_"]');

        notaInputs.forEach(function (input) {
            input.addEventListener('input', function () {
                const value = parseFloat(this.value);
                if (!isNaN(value) && value >= -1 && value <= 10) {
                    this.style.border = '';
                    this.setCustomValidity('');
                } else if (this.value === '') {
                    // Permite campos vazios sem erro
                    this.style.border = '';
                    this.setCustomValidity('');
                } else {
                    this.style.border = '1px solid red';
                    this.setCustomValidity('A nota deve estar entre -1 e 10.');
                }
            });
        });
    });
</script>

{% endblock %}
